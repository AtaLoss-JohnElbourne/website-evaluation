# /etc/nginx/sites-available/survey
# Survey application routes for apps.ataloss.org
# To enable: ln -s /etc/nginx/sites-available/survey /etc/nginx/sites-enabled/survey
#
# NOTE: This file only contains location blocks.
# Include it within the main server block in /etc/nginx/conf.d/apps.conf

# API endpoint - proxy to Node.js container
location /survey-api/ {
    # Use Docker's embedded DNS server for dynamic name resolution
    resolver 127.0.0.11 valid=30s;
    set $survey_api http://survey_api:3000;
    
    # Use container name from shared Docker network
    # Preserve /api path prefix - API routes are at /api/health, /api/survey, etc.
    # Rewrite the path: /survey-api/health -> /api/health
    rewrite ^/survey-api/(.*)$ /api/$1 break;
    proxy_pass $survey_api;
    proxy_http_version 1.1;
    
    # WebSocket support (if needed in future)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    
    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Disable buffering for real-time responses
    proxy_buffering off;
    proxy_cache_bypass $http_upgrade;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Static JavaScript file - proxy to nginx container
location /survey-web/ {
    # Use Docker's embedded DNS server for dynamic name resolution
    resolver 127.0.0.11 valid=30s;
    set $survey_web http://survey_api_web:3001;
    
    # Use container name from shared Docker network
    # Strip /survey-web/ prefix and pass the rest
    rewrite ^/survey-web/(.*)$ /$1 break;
    proxy_pass $survey_web;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # Cache control for JavaScript file
    # Short cache during development/testing, increase for production
    add_header Cache-Control "public, max-age=300, must-revalidate";
    
    # CORS headers for cross-origin requests from ataloss.org
    add_header Access-Control-Allow-Origin "https://ataloss.org" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "https://ataloss.org";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Max-Age 86400;
        add_header Content-Type "text/plain; charset=utf-8";
        add_header Content-Length 0;
        return 204;
    }
}
